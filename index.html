<!DOCTYPE html>
<html>
<head>
	<title>New York City Maps by Decade</title>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>

  <link rel="stylesheet" href="css/style.css" />
  <link rel="stylesheet" href="css/fonts.css" />

  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>

  <!--
  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v1.0.0-rc.1/leaflet.css" />
  <script src="http://cdn.leafletjs.com/leaflet/v1.0.0-rc.1/leaflet.js"></script>
  -->

  <script src="js/L.Map.Sync.js"></script>

  <script src="http://mourner.github.io/rbush/rbush.js"></script>
  <script src="//api.tiles.mapbox.com/mapbox.js/plugins/turf/v2.0.0/turf.min.js"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
			line-height: 1.5em;
    }

    .hidden {
      display: none !important;
    }

    body, .map {
    /*.leaflet-bar a, .leaflet-bar a:hover */
      background-color: #aed8e6;
    }

    article#all-maps-view {
      width: 900px;
      margin: 0 auto;
    }

    article#single-map-view {
      position: absolute;
      left: 0;
      right: 0;
      top: 0;
      bottom: 0;
      display: flex;
      flex-direction: row;
    }

		article#single-map-view,
		#single-map {
			background-color: #ffd72e;
		}

    article#single-map-view #single-map-container,
    article#single-map-view #sidebar {
			position: relative;
      height: 100%;
      width: 50%;
    }

		#single-map {
			width: 100%;
			height: 100%;
		}

		article#single-map-view #sidebar {
			overflow-y: auto;
		}

    #maps {
      list-style-type: none;
      display: flex;
      flex-wrap: wrap;
      justify-content: space-between;
      margin: 0;
      padding: 0;
    }

		.map-container {
			top: 0;
			width: 100%;
			height: 100%;
			position: absolute;
		}

    .map {
			width: 100%;
			height: 100%;
      border-color: rgb(196, 224, 232);
      border-style: solid;
      border-width: 1.5px;
			box-sizing: border-box;
      cursor: pointer;
    }

    .map:hover {
      border-color: #39484c;
    }

    .map .leaflet-control-zoom {
      display: none;
    }

    .map:hover .leaflet-control-zoom {
      display: block;
    }

    #maps li {
      /*padding: 8px;*/
    }

    .mini-map {
      position: relative;
      box-sizing: border-box;
			width: calc(33.333% - 8px);
			margin-bottom: 12px;
    }

		.mini-map:before {
			content: '';
			padding: 50% 0;
			display: inline-block;
		}

		.mini-map .map-message {
			text-align: center;
			left: 50%;
			position: absolute;
			bottom: 8px;
			width: 100%;
		}

		.mini-map .map-message span {
			opacity: 0;
			position: relative;
			left: -50%;
			display: inline-block;
      pointer-events: none;
			padding: 5px 8px;
			border-radius: 15px;
			background-color: rgba(255, 255, 255, 0.7);
			transition: opacity 0.25s;
		}

		.mini-map .map-message span.visible {
			opacity: 1;
		}

    .mini-map h2,
		#single-map-container h2,
		#single-map-container span {
      width: 100%;
      top: 5px;
      text-shadow: 0 0 4px rgb(196, 224, 232);
      text-align: center;
      margin: 0;
      position: absolute;
      pointer-events: none;
    }

		#single-map-container span {
			top: 35px;
			pointer-events: auto;
		}

    #images {
      position: fixed;
      top: 0;
      left: 950px;
      width: 600px;
      height: 600px;
    }

		#map-list {
			list-style-type: none;
			margin: 0;
			padding: 0;
			max-width: 600px;
		}

		#map-list li {
			padding: 10px;
		}

		#map-list img {
			width: 100%;
		}
  </style>
</head>
<body>
  <article id='all-maps-view'>
    <h1>New York City Maps by Decade</h1>
    <p>All New York City maps between 1830 and 1950, grouped by decade. Click on a map for more details.</p>
    <ol id="maps">
    </ol>
		<p>
			Note: only <a href="https://en.wikipedia.org/wiki/Scale_(map)#Large_scale.2C_medium_scale.2C_small_scale">large-scale</a> maps are shown in this visualization (e.g. maps depicting an area smaller than 1.5 kmÂ²). You can find more maps on <a href='http://maps.nypl.org/'>Map Warper</a> and <a href="http://digitalcollections.nypl.org/">Digital Collections</a>.
		</p>

  </article>
  <article id='single-map-view' class='hidden'>
    <div id='single-map-container'>
			<div id='single-map'>
	    </div>
			<h2></h2>
			<span><a href="#">Go back to all decades</a></span>
    </div>
    <div id='sidebar'>
			<ol id='map-list'>
			</ol>
    </div>
  </article>
</body>
<script>
  const center = [40.732504, -74.008712]
  const zoom = 10

  // var tileUrl = 'http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'
  var tileUrl = 'https://api.mapbox.com/styles/v1/bertspaan/cio0gk14s000hainh1ghuhmyu/tiles/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYmVydHNwYWFuIiwiYSI6ImR3dERiQk0ifQ.DLbScmbRohc3Sqv7prfhqw'

  var outlineStyle = {
    color: '#39484c',
    weight: 1.5,
    opacity: 0.7,
    fillOpacity: 0
  }

  var mapStyle = {
    color: '#39484c',
    fillColor: 'white',
    weight: 3,
    opacity: 1,
    fillOpacity: 0.2
  }

  var outlines = {}
  var maps = {}
  var trees = {}
  var leafletMaps = {}

	var singleMapBand

  var singleMap = L.map(`single-map`, {
    minZoom: 10,
    maxZoom: 18
  }).setView(center, zoom + 1)

  L.tileLayer(tileUrl, {
    opacity: 0.3
  }).addTo(singleMap)

	var mapwarperLayer = L.tileLayer('', {
  }).addTo(singleMap)

  var singleMapOutline = L.geoJson(null, {
    style: outlineStyle
  }).addTo(singleMap)

  var singleMapMap = L.geoJson(null, {
    style: mapStyle,
		onEachFeature: function (feature, layer) {
		  layer.on({
		    click: function(e) {
					singleMapDisableHover = true
				},
				dblclick: function(e) {
					// TODO: propagate to SingleMap
				}
		  })
		}
  }).addTo(singleMap)

	function findMaps(map, mapLayer, band, latlng, callback) {
		if (!trees[band]) {
			return
		}

		var results = trees[band].search([
			latlng.lng,
			latlng.lat,
			latlng.lng,
			latlng.lat
		])

		mapLayer.clearLayers()

		var hoveredMaps = []
		if (results.length) {
			var mapsForBand = maps[band]

			hoveredMaps = results.map(function (result) {
				return mapsForBand[result.index]
			})
			.filter(function(feature) {
				const point = {
					type: 'Feature',
					geometry: {
						type: 'Point',
						coordinates: [
							latlng.lng,
							latlng.lat
						]
					}
				}
				return turf.inside(point, feature)
			})

			if (hoveredMaps.length) {
				mapLayer.addData(hoveredMaps)
				callback(hoveredMaps)
			} else {
				callback([])
			}
		} else {
			callback([])
		}
	}

	var bandToPeriod = function(band) {
		return band + ' - ' + (band + 9)
	}

	var singleMapDisableHover = false

	document.getElementById('sidebar')
		.addEventListener('mouseover', function(e) {
			singleMapDisableHover = false
		})

	singleMap.on('mousemove', function(e) {
		if (singleMapDisableHover) {
			return
		}

		findMaps(singleMap, singleMapMap, singleMapBand, e.latlng, function(hoveredMaps) {
			var mapList = d3.select('#map-list').selectAll('li')
					.data(hoveredMaps, function(d) {
						return d.properties.id
					})

			var mapListItem = mapList.enter().append('li')

			mapListItem.append('img')
					.attr('src', function(d) {
						return 'http://images.nypl.org/index.php?id=' + d.properties.digital_id + '&t=w'
					})

			var details = mapListItem.append('div')

			var urnToMapId = function(urn) {
				return urn.replace('urn:hgid:mapwarper/', '')
			}

			details
				.append('div')
					.html(function(d) {
						return d.properties.name
					})

			details
				.append('div')
				.append('a')
					.attr('href', 'javascript:void(0)')
					.text('View on map')
					.on('click', function(d) {
						var tileUrl = 'http://maps.nypl.org/warper/maps/tile/' + urnToMapId(d.properties.id) + '/{z}/{x}/{y}.png'
						mapwarperLayer.setUrl(tileUrl)
					})

			details
				.append('div')
				.append('a')
					.attr('target', '_blank')
					.attr('href', function(d) {
						return 'http://maps.nypl.org/warper/maps/' + urnToMapId(d.properties.id)
					})
					.text('Open in Map Warper')

			details
				.append('div')
				.append('a')
					.attr('target', '_blank')
					.attr('href', function(d) {
						return d.properties.url
					})
					.text('Open in Digital Collections')

			mapList.exit().remove()
		})
	})

	var showAllMaps = function() {
		d3.select('#all-maps-view').classed('hidden', false)
		d3.select('#single-map-view').classed('hidden', true)
		mapwarperLayer.setUrl('')
		singleMapDisableHover = false
		location.hash = ''
	}

	document.onkeydown = function(e) {
    e = e || window.event
    if (e.keyCode == 27) {
			showAllMaps()
    }
	}

  d3.json('data/all.geojson', function(err, geojson) {
    geojson.features.forEach(function(feature) {
      var band = feature.properties.band
      if (!maps[band]) {
        maps[band] = []
      }

      maps[band].push(feature)
    })

    Object.keys(maps).forEach(function(band) {
      var mapsForBand = maps[band]
      var tree = rbush(mapsForBand.length)
      trees[band] = tree

      tree.load(
        mapsForBand.map(function(map, i) {
          var boundingbox = map.properties.boundingbox.slice()
          boundingbox.index = i
          return boundingbox
        })
      )
    })
  })

  d3.json('data/grouped.geojson', function(err, geojson) {
    var map = d3.select('#maps').selectAll('li').data(geojson.features)
        .enter()
      .append('li')
        .attr('class', 'mini-map')
				.attr('id', function (d, i) {
          return 'mini-map' + i
        })

    map.append('div')
		  	.attr('class', 'map-container')
			.append('div')
        .attr('class', 'map')
        .attr('id', function (d, i) {
          return 'map' + i
        })
        .each(function (d, i) {
          var band = d.properties.band

          outlines[band] = d

          var map = L.map('map' + i, {
            zoomControl: false,
            minZoom: zoom,
            maxZoom: zoom,
            attributionControl: false,
            scrollWheelZoom: false
          }).setView(center, zoom)

          leafletMaps[band] = map

          L.tileLayer(tileUrl, {
            opacity: 0.3
          }).addTo(map)

          L.geoJson(d, {
            style: outlineStyle
          }).addTo(map)

					var selectMap = function (e) {
            d3.select('#all-maps-view').classed('hidden', true)
            d3.select('#single-map-view').classed('hidden', false)

						d3.select('#single-map-container h2')
								.html(bandToPeriod(band))

						singleMapBand = band

						location.hash = band

            singleMapOutline.clearLayers()
            singleMapOutline.addData(outlines[band])

						singleMap.invalidateSize(false)
          }

          var mapLayer = L.geoJson(null, {
            style: mapStyle,
						onEachFeature: function (feature, layer) {
							layer.on({
								click: selectMap,
								dblclick: function(e) {
									// TODO: propagate to map
								}
							})
						}
          }).addTo(map)

          map.on('click', selectMap)

          map.on('mousemove', function(e) {
						findMaps(map, mapLayer, band, e.latlng, function(hoveredMaps) {
							d3.select('#mini-map' + i + ' .map-message span')
									.text(function (d) {
										var m = hoveredMaps.length <= 1 ? 'map' : 'maps'
										return Math.max(hoveredMaps.length, 1) + ' ' + m + ' found'
									})
									.classed('visible', hoveredMaps.length > 0)
						})
          })
        })

		map.append('div')
				.attr('class', 'map-message')
			.append('span')

    map.append('h2').text(function (d, i) {
      var band = d.properties.band
			return bandToPeriod(band)
    })

    Object.keys(leafletMaps).forEach(function(bandA) {
      Object.keys(leafletMaps).forEach(function(bandB) {
        if (bandA !== bandB) {
          leafletMaps[bandA].sync(leafletMaps[bandB])
        }
      })
    })
  })
</script>
</html>
